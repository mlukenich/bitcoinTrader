<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trading Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">

<div class="container mx-auto p-4 md:p-8">
    <h1 class="text-3xl font-bold mb-6 text-cyan-400">Trading Bot Dashboard</h1>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- Left Column -->
        <div class="md:col-span-2 bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Bot Status</h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <div>
                    <span class="text-sm text-gray-400">Status</span>
                    <p id="status" class="text-lg font-bold text-yellow-400">-</p>
                </div>
                <div>
                    <span class="text-sm text-gray-400">Position</span>
                    <p id="position" class="text-lg font-bold">-</p>
                </div>
                <div>
                    <span class="text-sm text-gray-400">Entry Price</span>
                    <p id="entryPrice" class="text-lg font-bold">-</p>
                </div>
                <div>
                    <span class="text-sm text-gray-400">Current Price</span>
                    <p id="currentPrice" class="text-lg font-bold">-</p>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Account Status</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <span class="text-sm text-gray-400">Equity</span>
                    <p id="equity" class="text-lg font-bold">-</p>
                </div>
                <div>
                    <span class="text-sm text-gray-400">Unrealized P/L</span>
                    <p id="unrealizedPL" class="text-lg font-bold">-</p>
                </div>
            </div>
            <div class="mt-6 flex space-x-4">
                <button id="startButton" onclick="startBot()"
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="button-text">Start</span>
                    <span class="spinner hidden animate-spin-fast">◐</span>
                </button>
                <button id="stopButton" onclick="stopBot()"
                        class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="button-text">Stop</span>
                    <span class="spinner hidden animate-spin-fast">◐</span>
                </button>
            </div>
        </div>

        <!-- Log Area -->
        <div class="md:col-span-3 bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Recent Activity</h2>
            <div id="logs" class="h-64 overflow-y-auto bg-gray-900 rounded-md p-4 text-sm font-mono">
                <!-- Logs will be dynamically inserted here -->
            </div>
        </div>
    </div>
</div>

<script>
    const statusEl = document.getElementById('status');
    const positionEl = document.getElementById('position');
    const entryPriceEl = document.getElementById('entryPrice');
    const currentPriceEl = document.getElementById('currentPrice');
    const equityEl = document.getElementById('equity');
    const unrealizedPLEl = document.getElementById('unrealizedPL');
    const logsEl = document.getElementById('logs');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');

    function connect() {
        const socket = new WebSocket('ws://localhost:8080/ws');
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            addLogEntry('UI connected to server.', 'text-cyan-400');
            stompClient.subscribe('/topic/updates', function (message) {
                updateDashboard(JSON.parse(message.body));
            });
            // Request initial state after connection
            fetch('/api/state')
                .then(response => response.json())
                .then(updateDashboard);
        }, function(error) {
            console.error('STOMP error', error);
            addLogEntry('Connection lost. Attempting to reconnect...', 'text-red-500');
            setTimeout(connect, 5000); // Reconnect after 5 seconds
        });
    }

    function updateDashboard(state) {
        statusEl.textContent = state.running ? 'Running' : 'Stopped';
        statusEl.className = `text-lg font-bold ${state.running ? 'text-green-400' : 'text-red-400'}`;

        positionEl.textContent = state.position.positionType || 'None';
        entryPriceEl.textContent = state.position.entryPrice ? `$${state.position.entryPrice.toFixed(2)}` : '-';
        currentPriceEl.textContent = state.currentPrice ? `$${state.currentPrice.toFixed(2)}` : '-';
        equityEl.textContent = state.equity ? `$${state.equity.toFixed(2)}` : '-';

        const pl = state.unrealizedPL || 0;
        unrealizedPLEl.textContent = `$${pl.toFixed(2)}`;
        if (pl >= 0) {
            unrealizedPLEl.className = 'text-lg font-bold text-green-400';
        } else {
            unrealizedPLEl.className = 'text-lg font-bold text-red-400';
        }

        if (state.logs) {
            logsEl.innerHTML = ''; // Clear existing logs
            state.logs.forEach(log => addLogEntry(log.message, '', log.timestamp));
        }
    }

    function addLogEntry(message, styleClass = '', timestamp) {
        const logEntry = document.createElement('div');
        const timeString = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
        logEntry.innerHTML = `<span class="text-gray-500">[${timeString}]</span> <span class="${styleClass}">${message}</span>`;
        logsEl.appendChild(logEntry);
        logsEl.scrollTop = logsEl.scrollHeight; // Auto-scroll to bottom
    }

    function startBot() {
        setButtonState(startButton, true);
        fetch('/api/start', { method: 'POST' })
            .finally(() => setButtonState(startButton, false));
    }

    function stopBot() {
        setButtonState(stopButton, true);
        fetch('/api/stop', { method: 'POST' })
            .finally(() => setButtonState(stopButton, false));
    }

    function setButtonState(button, isLoading) {
        const text = button.querySelector('.button-text');
        const spinner = button.querySelector('.spinner');
        if (isLoading) {
            button.disabled = true;
            text.classList.add('hidden');
            spinner.classList.remove('hidden');
        } else {
            button.disabled = false;
            text.classList.remove('hidden');
            spinner.classList.add('hidden');
        }
    }

    // Initial connection
    connect();

</script>
</body>
</html>